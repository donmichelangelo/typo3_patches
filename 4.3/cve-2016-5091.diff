From 54b705b0410d1e7af1d2c1f1d754beb1887e3749 Mon Sep 17 00:00:00 2001
From: Nicole Cordes <typo3@cordes.co>
Date: Mon, 23 May 2016 23:38:51 +0200
Subject: [PATCH] [SECURITY] Validate complete referring request

Instead of only checking for valid request arguments by using a hmac,
we now check the complete request including action, controller and vendor
to avoid spoofing these arguments and bypassing other security checks
during forwarding to the referring action.

Additionally, ReferringRequest is now separate from regular Request.
The meaning of properties starting with "@" is only valid for
processing a referring request. To avoid mixed concerns in using
the same Request implementation for regular requests and referring
requests, they are separated now.

Resolves: #76231
Resolves: #76256
Releases: master, 7.6, 6.2
Change-Id: I9ce59fd9df60e84251cc6f75e6b5f032da0b3c64
---
 .../Classes/MVC/Controller/ActionController.php    |   22 ++++++++-
 .../Classes/Security/Cryptography/HashService.php  |   43 ++++++++++++++++++
 .../Classes/Security/Exception/InvalidHash.php     |   34 ++++++++++++++
 typo3/sysext/extbase/ext_autoload.php              |    1 +
 .../fluid/Classes/ViewHelpers/FormViewHelper.php   |   47 ++++++++++++++++++++
 5 files changed, 145 insertions(+), 2 deletions(-)
 create mode 100644 typo3/sysext/extbase/Classes/Security/Exception/InvalidHash.php

diff --git a/typo3/sysext/extbase/Classes/MVC/Controller/ActionController.php b/typo3/sysext/extbase/Classes/MVC/Controller/ActionController.php
index e253248..fef8e62 100644
--- a/typo3/sysext/extbase/Classes/MVC/Controller/ActionController.php
+++ b/typo3/sysext/extbase/Classes/MVC/Controller/ActionController.php
@@ -353,8 +353,12 @@ class Tx_Extbase_MVC_Controller_ActionController extends Tx_Extbase_MVC_Controll
 		}

 		if ($this->request->hasArgument('__referrer')) {
-			$referrer = $this->request->getArgument('__referrer');
-			$this->forward($referrer['actionName'], $referrer['controllerName'], $referrer['extensionName'], $this->request->getArguments());
+			$referrerArguments = $this->request->getArgument('__referrer');
+			if (isset($referrerArguments['@request'])) {
+				$cryptographyHashService = t3lib_div::makeInstance('Tx_Extbase_Security_Cryptography_HashService');
+				$referrer = unserialize($cryptographyHashService->validateAndStripHmac($referrerArguments['@request']));
+				$this->forward($referrer['actionName'], $referrer['controllerName'], $referrer['extensionName'], $this->request->getArguments());
+			}
 		}

 		$message = 'An error occurred while trying to call ' . get_class($this) . '->' . $this->actionMethodName . '().' . PHP_EOL;
diff --git a/typo3/sysext/extbase/Classes/Security/Cryptography/HashService.php b/typo3/sysext/extbase/Classes/Security/Cryptography/HashService.php
index 2e4ca3b..97ac3da 100644
--- a/typo3/sysext/extbase/Classes/Security/Cryptography/HashService.php
+++ b/typo3/sysext/extbase/Classes/Security/Cryptography/HashService.php
@@ -60,5 +60,48 @@ class Tx_Extbase_Security_Cryptography_HashService implements t3lib_singleton {
 	public function validateHash($string, $hash) {
 		return ($this->generateHash($string) === $hash);
 	}
+
+	/**
+	 * Appends a hash (HMAC) to a given string and returns the result
+	 *
+	 * @param string $string The string for which a hash should be generated
+	 * @return string The original string with HMAC of the string appended
+	 * @see generateHash()
+	 * @todo Mark as API once it is more stable
+	 */
+	public function appendHmac($string) {
+		$hmac = $this->generateHash($string);
+
+		return $string . $hmac;
+	}
+
+	/**
+	 * Tests if the last 40 characters of a given string $string
+	 * matches the HMAC of the rest of the string and, if true,
+	 * returns the string without the HMAC. In case of a HMAC
+	 * validation error, an exception is thrown.
+	 *
+	 * @param string $string The string with the HMAC appended (in the format 'string<HMAC>')
+	 * @return string the original string without the HMAC, if validation was successful
+	 * @see validateHash()
+	 * @throws Tx_Extbase_Security_Exception_InvalidArgumentForHashGeneration if the given string is not well-formatted
+	 * @throws Tx_Extbase_Security_Exception_InvalidHashException if the hash did not fit to the data.
+	 * @todo Mark as API once it is more stable
+	 */
+	public function validateAndStripHmac($string) {
+		if (!is_string($string)) {
+			throw new Tx_Extbase_Security_Exception_InvalidArgumentForHashGeneration('A hash can only be validated for a string, but "' . gettype($string) . '" was given.', 1320829762);
+		}
+		if (strlen($string) < 40) {
+			throw new Tx_Extbase_Security_Exception_InvalidArgumentForHashGeneration('A hashed string must contain at least 40 characters, the given string was only ' . strlen($string) . ' characters long.', 1320830276);
+		}
+		$stringWithoutHmac = substr($string, 0, -40);
+		if (!$this->validateHash($stringWithoutHmac, substr($string, -40))) {
+			throw new Tx_Extbase_Security_Exception_InvalidHashException('The given string was not appended with a valid HMAC.', 1320830018);
+		}
+
+		return $stringWithoutHmac;
+	}
 }
+
 ?>
\ No newline at end of file
diff --git a/typo3/sysext/extbase/Classes/Security/Exception/InvalidHash.php b/typo3/sysext/extbase/Classes/Security/Exception/InvalidHash.php
new file mode 100644
index 0000000..1696507
--- /dev/null
+++ b/typo3/sysext/extbase/Classes/Security/Exception/InvalidHash.php
@@ -0,0 +1,34 @@
+<?php
+/***************************************************************
+ *  Copyright notice
+ *
+ *  (c) 2016 Steffen MÃ¼ller <typo3@t3node.com>
+ *  All rights reserved
+ *
+ *  This class is a backport of the corresponding class of FLOW3.
+ *  All credits go to the v5 team.
+ *
+ *  This script is part of the TYPO3 project. The TYPO3 project is
+ *  free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  The GNU General Public License can be found at
+ *  http://www.gnu.org/copyleft/gpl.html.
+ *
+ *  This script is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  This copyright notice MUST APPEAR in all copies of the script!
+ ***************************************************************/
+
+/**
+ * An "InvalidHash" Exception, thrown when a HMAC validation failed.
+ */
+class Tx_Extbase_Security_Exception_InvalidHashException extends Tx_Extbase_Security_Exception {
+}
+
+?>
\ No newline at end of file
diff --git a/typo3/sysext/extbase/ext_autoload.php b/typo3/sysext/extbase/ext_autoload.php
index a1023e8..6a831be 100644
--- a/typo3/sysext/extbase/ext_autoload.php
+++ b/typo3/sysext/extbase/ext_autoload.php
@@ -184,6 +184,7 @@ return array(
 	'tx_extbase_security_cryptography_hashservice' => $extensionClassesPath . 'Security/Cryptography/HashService.php',
 	'tx_extbase_security_exception_invalidargumentforhashgeneration' => $extensionClassesPath . 'Security/Exception/InvalidArgumentForHashGeneration.php',
 	'tx_extbase_security_exception_invalidargumentforrequesthashgeneration' => $extensionClassesPath . 'Security/Exception/InvalidArgumentForRequestHashGeneration.php',
+	'tx_extbase_security_exception_invalidhashexception' => $extensionClassesPath . 'Security/Exception/InvalidHash.php',
 	'tx_extbase_security_exception_syntacticallywrongrequesthash' => $extensionClassesPath . 'Security/Exception/SyntacticallyWrongRequestHash.php',
 	'tx_extbase_utility_arrays' => $extensionClassesPath . 'Utility/Arrays.php',
 	'tx_extbase_utility_cache' => $extensionClassesPath . 'Utility/Cache.php',
diff --git a/typo3/sysext/fluid/Classes/Compatibility/ObjectFactory.php b/typo3/sysext/fluid/Classes/Compatibility/ObjectFactory.php
index 230aa03..4ed555c 100644
--- a/typo3/sysext/fluid/Classes/Compatibility/ObjectFactory.php
+++ b/typo3/sysext/fluid/Classes/Compatibility/ObjectFactory.php
@@ -49,7 +49,8 @@ class Tx_Fluid_Compatibility_ObjectFactory implements t3lib_Singleton {
 			'injectObjectManager' => 'Tx_Extbase_Object_Manager'
 		),
 		'Tx_Fluid_ViewHelpers_FormViewHelper' => array(
-			'injectRequestHashService' => 'Tx_Extbase_Security_Channel_RequestHashService'
+			'injectRequestHashService' => 'Tx_Extbase_Security_Channel_RequestHashService',
+			'injectCryptographyHashService' => 'Tx_Extbase_Security_Cryptography_HashService'
 		)
 	);

diff --git a/typo3/sysext/fluid/Classes/ViewHelpers/FormViewHelper.php b/typo3/sysext/fluid/Classes/ViewHelpers/FormViewHelper.php
index 8e1e26d..861ee18 100644
--- a/typo3/sysext/fluid/Classes/ViewHelpers/FormViewHelper.php
+++ b/typo3/sysext/fluid/Classes/ViewHelpers/FormViewHelper.php
@@ -72,6 +72,16 @@ class Tx_Fluid_ViewHelpers_FormViewHelper extends Tx_Fluid_ViewHelpers_Form_Abst
 	protected $requestHashService;

 	/**
+	 * @var Tx_Extbase_Security_Cryptography_HashService
+	 */
+	protected $cryptographyHashService;
+
+	/**
+	 * @var boolean
+	 */
+	private $securedReferrerFieldRendered = FALSE;
+
+	/**
 	 * Inject a request hash service
 	 *
 	 * @param Tx_Extbase_Security_Channel_RequestHashService $requestHashService The request hash service
@@ -83,6 +93,16 @@ class Tx_Fluid_ViewHelpers_FormViewHelper extends Tx_Fluid_ViewHelpers_Form_Abst
 	}

 	/**
+	 * Inject a cryptography hash service
+	 *
+	 * @param Tx_Extbase_Security_Cryptography_HashService $cryptographyHashService The cryptography hash service
+	 * @return void
+	 */
+	public function injectCryptographyHashService(Tx_Extbase_Security_Cryptography_HashService $cryptographyHashService) {
+		$this->cryptographyHashService = $cryptographyHashService;
+	}
+
+	/**
 	 * Initialize arguments.
 	 *
 	 * @return void
@@ -131,6 +151,7 @@ class Tx_Fluid_ViewHelpers_FormViewHelper extends Tx_Fluid_ViewHelpers_Form_Abst
 		$content = $this->renderHiddenIdentityField($this->arguments['object'], $this->arguments['name']);
 		$content .= $this->renderAdditionalIdentityFields();
 		$content .= $this->renderHiddenReferrerFields();
+		$content .= $this->renderHiddenSecuredReferrerField();
 		$content .= $this->renderRequestHashField(); // Render hmac after everything else has been rendered
 		$content .= $formContent;

@@ -199,6 +220,32 @@ class Tx_Fluid_ViewHelpers_FormViewHelper extends Tx_Fluid_ViewHelpers_Form_Abst
 		$result .= '<input type="hidden" name="' . $this->prefixFieldName('__referrer[extensionName]') . '" value="' . $extensionName . '" />' . chr(10);
 		$result .= '<input type="hidden" name="' . $this->prefixFieldName('__referrer[controllerName]') . '" value="' . $controllerName . '" />' . chr(10);
 		$result .= '<input type="hidden" name="' . $this->prefixFieldName('__referrer[actionName]') . '" value="' . $actionName . '" />' . chr(10);
+		$result .= $this->renderHiddenSecuredReferrerField();
+		return $result;
+	}
+
+	/**
+	 * Renders hidden form field for secured referrer information about the current controller and action.
+	 *
+	 * This method is called twice, to deal with subclasses of this class in a most compatible way
+	 *
+	 * @return string Hidden field with secured referrer information
+	 */
+	protected function renderHiddenSecuredReferrerField() {
+		if ($this->securedReferrerFieldRendered) {
+			return '';
+		}
+		$request = $this->controllerContext->getRequest();
+		$extensionName = $request->getControllerExtensionName();
+		$controllerName = $request->getControllerName();
+		$actionName = $request->getControllerActionName();
+		$actionRequest = array(
+			'extensionName' => $extensionName,
+			'controllerName' => $controllerName,
+			'actionName' => $actionName,
+		);
+		$result = '<input type="hidden" name="' . $this->prefixFieldName('__referrer[@request]') . '" value="' . htmlspecialchars($this->cryptographyHashService->appendHmac(serialize($actionRequest))) . '" />' . chr(10);
+		$this->securedReferrerFieldRendered = TRUE;
 		return $result;
 	}
